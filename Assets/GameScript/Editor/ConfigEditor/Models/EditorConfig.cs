
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using UnityEditor;
using SimpleJSON;
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

namespace GameEditor.ConfigEditor.Model
{
    public interface IConfigEditorTable
    {
        void Load();
        void Save();
        void OnGUI();
        void Sort();
        bool IsLoaded { get; }
        void ResolveRef(EditorConfig tables);
    }

    public partial class EditorConfig
    {
        private const string _jsonConfigDirPath = "Config/Datas/DataJson";
        private string _currentTable = "";
        private Dictionary<string, IConfigEditorTable> _tables;
        private string[] _tableNames;

        public string CurrentTable => _currentTable;

        public EditorConfig(System.Func<string, string> pathFunc)
        {
            _tables = new Dictionary<string, IConfigEditorTable>();
            var path = string.Empty;
            path = pathFunc("buffcategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("BuffCategory", new BuffCategory(path));
            }
            path = pathFunc("buffdicecategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("BuffDiceCategory", new BuffDiceCategory(path));
            }
            path = pathFunc("skillconfigcategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("SkillConfigCategory", new SkillConfigCategory(path));
            }
            path = pathFunc("skilldicefaceconfigcategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("SkillDiceFaceConfigCategory", new SkillDiceFaceConfigCategory(path));
            }
            path = pathFunc("battleaicategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("BattleAICategory", new BattleAICategory(path));
            }
            path = pathFunc("avg_avgconfigcategory");
            if (!string.IsNullOrEmpty(path))
            {
                _tables.Add("Avg.AvgConfigCategory", new Avg.AvgConfigCategory(path));
            }

            _tableNames = new string[]{"æ— "}.Concat(_tables.Keys).ToArray();
            ResolveRef();
        }

        public void SaveAll()
        {
            foreach (var data in _tables)
            {
                if(data.Value.IsLoaded)
                {
                    data.Value.Save();
                }
            }
        }


        private IConfigEditorTable LoadTable(string tableName, bool forceLoad = false)
        {
            if (!_tables.TryGetValue(_currentTable, out var table))
            {
                return null;
            }
            if (forceLoad || !table.IsLoaded)
            {
                table.Load();
            }
            return table;
        }

        public void ReloadAll()
        {
            foreach (var key in _tables.Keys)
            {
                LoadTable(key, true);
            }
        }

        public void OnGUI()
        {
            DrawTopBar();
            DrawTable();
        }

        public void DrawTopBar()
        {
            GUILayout.BeginHorizontal();
            
            var index = System.Array.IndexOf(_tableNames, _currentTable);
            if (index < 0)
            {
                index = 0;
            }
            index = EditorGUILayout.Popup(index, _tableNames, GUILayout.Width(100));
            _currentTable = _tableNames[index];


            if (GUILayout.Button("Save", GUILayout.Width(100)))
            {
                SaveAll();
            }
            GUILayout.EndHorizontal();
            GUILayout.BeginHorizontal();
            ConfigEditorSettings.showComment = GUILayout.Toggle(ConfigEditorSettings.showComment, "Show Comment", GUILayout.Width(120));
            GUILayout.EndHorizontal();
        }

        private void DrawTable()
        {
            var table = LoadTable(_currentTable);
            table?.OnGUI();
        }

        private void ResolveRef()
        {
            foreach (var table in _tables)
            {
                table.Value.ResolveRef(this);
            }
        }
    }
    
}
